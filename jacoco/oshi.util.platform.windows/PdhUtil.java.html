<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PdhUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Operating System and Hardware Information</a> &gt; <a href="index.source.html" class="el_package">oshi.util.platform.windows</a> &gt; <span class="el_source">PdhUtil.java</span></div><h1>PdhUtil.java</h1><pre class="source lang-java linenums">/**
 * Oshi (https://github.com/dblock/oshi)
 *
 * Copyright (c) 2010 - 2016 The Oshi Project Team
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Maintainers:
 * dblock[at]dblock[dot]org
 * widdis[at]gmail[dot]com
 * enrico.bianchi[at]gmail[dot]com
 *
 * Contributors:
 * https://github.com/dblock/oshi/graphs/contributors
 */
package oshi.util.platform.windows;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.sun.jna.ptr.IntByReference;
import com.sun.jna.ptr.PointerByReference;

import oshi.jna.platform.windows.Pdh;
import oshi.jna.platform.windows.Pdh.PdhFmtCounterValue;

/**
 * Provides access to open pdh queries and add/query counters
 * 
 * @author widdis[at]gmail[dot]com
 */
<span class="nc" id="L35">public class PdhUtil {</span>
<span class="nc" id="L36">    private static final Logger LOG = LoggerFactory.getLogger(PdhUtil.class);</span>

<span class="nc" id="L38">    private static final IntByReference PZERO = new IntByReference(0);</span>

    /**
     * Open a pdh query
     * 
     * @param p
     *            pointer to the query
     * @return true if successful
     */
    public static boolean openQuery(PointerByReference p) {
<span class="nc" id="L48">        int pdhOpenQueryError = Pdh.INSTANCE.PdhOpenQuery(null, PZERO, p);</span>
<span class="nc bnc" id="L49" title="All 2 branches missed.">        if (pdhOpenQueryError != 0) {</span>
<span class="nc" id="L50">            LOG.error(&quot;Failed to open PDH Query. Error code: {}&quot;, String.format(&quot;0x%08X&quot;, pdhOpenQueryError));</span>
        }
<span class="nc bnc" id="L52" title="All 2 branches missed.">        return pdhOpenQueryError == 0;</span>
    }

    /**
     * Adds a pdh counter to a query
     * 
     * @param query
     *            Pointer to the query to add the counter
     * @param path
     *            String name of the PerfMon counter
     * @param p
     *            Pointer to the counter
     */
    public static void addCounter(PointerByReference query, String path, PointerByReference p) {
<span class="nc" id="L66">        int pdhAddCounterError = Pdh.INSTANCE.PdhAddEnglishCounterA(query.getValue(), path, PZERO, p);</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">        if (pdhAddCounterError != 0) {</span>
<span class="nc" id="L68">            LOG.error(&quot;Failed to add PDH Counter: {}, Error code: {}&quot;, path,</span>
<span class="nc" id="L69">                    String.format(&quot;0x%08X&quot;, pdhAddCounterError));</span>
        }
<span class="nc" id="L71">    }</span>

    /**
     * Update counters to values since the last call
     * 
     * @param query
     *            The query whose counters to update
     * @return True if successful
     */
    public static boolean updateCounters(PointerByReference query) {
<span class="nc" id="L81">        int ret = Pdh.INSTANCE.PdhCollectQueryData(query.getValue());</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">        if (ret != 0) {</span>
<span class="nc" id="L83">            LOG.error(&quot;Failed to update counters. Error code: {}&quot;, String.format(&quot;0x%08X&quot;, ret));</span>
<span class="nc" id="L84">            return false;</span>
        }
<span class="nc" id="L86">        return true;</span>
    }

    /**
     * Get value of pdh counter
     * 
     * @param counter
     *            The counter to get the value of
     * @return long value of the counter x 1000
     */
    public static long queryCounter(PointerByReference counter) {
<span class="nc" id="L97">        PdhFmtCounterValue counterValue = new PdhFmtCounterValue();</span>
<span class="nc" id="L98">        int ret = Pdh.INSTANCE.PdhGetFormattedCounterValue(counter.getValue(), Pdh.PDH_FMT_LARGE | Pdh.PDH_FMT_1000,</span>
                null, counterValue);
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (ret != 0) {</span>
<span class="nc" id="L101">            LOG.warn(&quot;Failed to get counter. Error code: {}&quot;, String.format(&quot;0x%08X&quot;, ret));</span>
<span class="nc" id="L102">            return 0L;</span>
        }
<span class="nc" id="L104">        return counterValue.value.largeValue;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>